<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Concierium | CLIENTE (SPA)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--bg:#0c0c0f;--muted:#9aa3b2;--text:#e9ecf1;--brand:#00c9a7;--card:#161622;--ok:#19c37d;--warn:#f5a524;--err:#ef4444;--shadow:0 12px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:radial-gradient(1200px 800px at 100% -10%, rgba(0,201,167,.12), transparent 55%),
                 radial-gradient(1200px 900px at -10% 110%, rgba(64,68,237,.12), transparent 55%),#0c0c0f;
      display:grid;grid-template-rows:auto 1fr}
    header{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:14px 18px;background:rgba(18,18,24,.75);backdrop-filter: blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
    .brand{display:flex;align-items:center;gap:10px}.brand b{letter-spacing:.4px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06));color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px}
    .wrap{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 64px)}
    aside{padding:18px;background:rgba(16,16,26,.72);border-right:1px solid rgba(255,255,255,.06)}
    .nav{display:grid;gap:8px}.nav a{padding:10px 12px;border-radius:12px;color:var(--text);text-decoration:none}
    .nav a:hover{background:rgba(255,255,255,.06)} .nav a.active{background:linear-gradient(180deg, rgba(0,201,167,.14), rgba(0,201,167,.05));border:1px solid rgba(0,201,167,.25)}
    main{padding:20px} h2{margin:10px 0 12px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12, minmax(0,1fr))}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12));border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    @media (max-width:1100px){ .col-4,.col-6,.col-8{grid-column:span 12} }
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1018;color:var(--text)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px} thead th{font-size:12px;color:var(--muted);text-align:left;font-weight:500;padding:0 10px}
    tbody tr{background:#161622;border:1px solid rgba(255,255,255,.06)} tbody td{padding:10px}
    .muted{color:var(--muted)} .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);margin-right:6px}
    .errorbox{margin-top:8px;padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#2a1720;color:#ffb4c0}
    #toast{position:fixed;right:14px;bottom:14px;display:none;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#161622;color:var(--text);box-shadow:var(--shadow);z-index:9999}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <b>Concierium — CLIENTE (SPA)</b>
      <span id="who" style="margin-left:8px;color:#9aa3b2"></span>
    </div>
    <div style="margin-left:auto;display:flex;gap:10px">
      <button class="btn" id="btnLogout" style="display:none">Salir</button>
    </div>
  </header>

  <div class="wrap">
    <aside>
      <nav class="nav" id="leftNav" style="display:none">
        <a href="#home" class="active">Home</a>
        <a href="#nueva">Nueva solicitud</a>
        <a href="#mis-solicitudes">Mis solicitudes</a>
         <a href="#calendario">Calendario</a> <!-- NUEVO -->
      </nav>
    </aside>

    <main>
      <!-- LOGIN -->
      <section id="login" class="section">
        <h2>Iniciar sesión</h2>
        <div id="loginErr" class="errorbox" style="display:none"></div>
        <div class="card col-6" style="max-width:560px">
          <form id="formLogin">
            <label>Email</label>
            <input name="email" type="email" required placeholder="tu@correo.com"/>
            <label>Contraseña</label>
            <input name="password" type="password" required placeholder="••••••••"/>
            <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
              <button class="btn" type="submit">Entrar</button>
              <span class="muted">Acceso al área de cliente</span>
            </div>
          </form>
        </div>
      </section>

      <!-- HOME -->
      <section id="home" class="section" style="display:none">
        <h2>Resumen</h2>
        <div id="homeErr" class="errorbox" style="display:none"></div>
        <div class="grid">
          <div class="card col-12">
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <div><b>Total mis solicitudes:</b> <span id="kpiMine">—</span></div>
              <div id="chipsMine" style="display:flex;gap:8px;flex-wrap:wrap"></div>
              <button class="btn" id="btnRefreshClient" style="margin-left:auto">Refrescar</button>
            </div>
          </div>
          <div class="card col-12">
            <h3>Recientes</h3>
            <div style="overflow:auto">
              <table>
                <thead>
                  <tr><th>Folio</th><th>Servicio</th><th>Destino</th><th>Estado</th><th>Creada</th><th></th></tr>
                </thead>
                <tbody id="tblMyRecent"><tr><td colspan="6">Cargando…</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- NUEVA -->
      <section id="nueva" class="section" style="display:none">
        <h2>Nueva solicitud</h2>
        <div id="newErr" class="errorbox" style="display:none"></div>
        <div class="grid">
          <div class="card col-8">
            <form id="formNewReq">
              <div class="grid">
                <div class="col-6">
                  <label>Tipo de servicio</label>
                  <select name="service_kind" id="selKindNew" required>
                    <option value="">— selecciona —</option>
                    <option value="lodging">lodging</option>
                    <option value="tour">tour</option>
                    <option value="dining">dining</option>
                    <option value="vip">vip</option>
                  </select>
                </div>
                <div class="col-6">
                  <label>Destino</label>
                  <select name="destination_id" id="selDestinationNew">
                    <option value="">— selecciona —</option>
                  </select>
                </div>
                <div class="col-6">
                  <label>Servicio (catálogo) — opcional</label>
                  <select name="catalog_id" id="selServiceNew">
                    <option value="">— (opcional) —</option>
                  </select>
                </div>
                <div class="col-3">
                  <label>Desde</label>
                  <input type="date" name="start_date">
                </div>
                <div class="col-3">
                  <label>Hasta</label>
                  <input type="date" name="end_date">
                </div>
                <div class="col-3">
                  <label>Huéspedes</label>
                  <input type="number" name="guests" min="1">
                </div>
                <div class="col-3">
                  <label>Presupuesto (USD)</label>
                  <input type="number" name="budget_usd" step="0.01" min="0">
                </div>
                <div class="col-12">
                  <label>Preferencias alimentarias (opcional)</label>
                  <input name="dietary_notes" placeholder="Vegano, sin gluten, etc.">
                </div>
                <div class="col-12">
                  <label>Intereses (opcional, separa por comas)</label>
                  <input name="interests" placeholder="playa, cultura, aventura…">
                </div>
                <div class="col-12">
                  <label>Notas</label>
                  <textarea name="notes" rows="3" placeholder="Detalles adicionales"></textarea>
                </div>
              </div>
              <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
                <button class="btn" type="submit">Enviar solicitud</button>
                <span id="msgNewReq" class="muted"></span>
              </div>
            </form>
          </div>
          <div class="card col-4">
            <h3>Ayuda</h3>
            <p class="muted">Selecciona tipo, destino y (opcional) un servicio del catálogo. Puedes indicar fechas, presupuesto y notas.</p>
          </div>
        </div>
      </section>

      <!-- MIS SOLICITUDES -->
      <section id="mis-solicitudes" class="section" style="display:none">
        <h2>Mis solicitudes</h2>
        <div id="listErr" class="errorbox" style="display:none"></div>
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="muted">Filtrar estado</label>
            <select id="fltStatusMyReq">
              <option value="">(todos)</option>
              <option>new</option><option>curation</option><option>proposal_sent</option>
              <option>confirmed</option><option>closed</option><option>discarded</option>
            </select>
            <button class="btn" id="btnLoadMyReq">Cargar</button>
          </div>
        </div>
        <div class="card">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Folio</th><th>Servicio</th><th>Destino</th><th>Fecha</th><th>Estado</th><th></th></tr>
              </thead>
              <tbody id="tblMyReq"><tr><td colspan="6">Cargando…</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EDIT -->
      <section id="solicitud-edit" class="section" style="display:none">
        <h2>Editar solicitud</h2>
        <div id="editErr" class="errorbox" style="display:none"></div>
        <div class="card" style="margin-bottom:12px;display:flex;gap:10px">
          <a class="btn" href="#mis-solicitudes">← Volver a Mis solicitudes</a>
          <button class="btn" id="btnCancelReq">Cancelar solicitud</button>
        </div>

        <div class="grid">
          <div class="card col-6">
            <h3>Formulario</h3>
            <form id="formReqEdit">
              <input type="hidden" name="id">
              <div class="grid">
                <div class="col-6">
                  <label>Tipo de servicio</label>
                  <select name="service_kind" required>
                    <option value="lodging">lodging</option>
                    <option value="tour">tour</option>
                    <option value="dining">dining</option>
                    <option value="vip">vip</option>
                  </select>
                </div>
                <div class="col-6">
                  <label>Destino</label>
                  <select name="destination_id" id="selDestinationEdit">
                    <option value="">— sin destino —</option>
                  </select>
                </div>
                <div class="col-12">
                  <label>Servicio (catálogo) — opcional</label>
                  <select name="catalog_id" id="selServiceEdit">
                    <option value="">— (opcional) —</option>
                  </select>
                </div>
                <div class="col-6">
                  <label>Desde</label>
                  <input type="date" name="start_date">
                </div>
                <div class="col-6">
                  <label>Hasta</label>
                  <input type="date" name="end_date">
                </div>
                <div class="col-6">
                  <label>Huéspedes</label>
                  <input type="number" name="guests" min="1">
                </div>
                <div class="col-6">
                  <label>Presupuesto (USD)</label>
                  <input type="number" name="budget_usd" step="0.01" min="0">
                </div>
                <div class="col-12">
                  <label>Preferencias alimentarias</label>
                  <input name="dietary_notes" placeholder="Vegano, sin gluten, etc.">
                </div>
                <div class="col-12">
                  <label>Intereses (separa por comas)</label>
                  <input name="interests" placeholder="playa, cultura, aventura…">
                </div>
                <div class="col-12">
                  <label>Notas</label>
                  <textarea name="notes" rows="3" placeholder="Detalles adicionales"></textarea>
                </div>
              </div>
              <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
                <button class="btn" type="submit">Guardar cambios</button>
                <span id="msgReqEdit" class="muted"></span>
              </div>
            </form>
          </div>

          <div class="card col-6">
            <h3>Resumen</h3>
            <div id="reqPreview" class="muted">—</div>
            <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:16px 0"/>
            <h3>Adjuntos</h3>
            <ul id="attachmentsList" style="list-style:none;padding:0;margin:0;display:grid;gap:8px">
              <li class="muted">—</li>
            </ul>
            <form id="formUpload" style="margin-top:12px">
              <input type="hidden" name="request_id" id="uploadRequestId">
              <label>Subir archivo (PDF/JPG/PNG, máx 10MB)</label>
              <input type="file" name="file" accept="application/pdf,image/png,image/jpeg">
              <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
                <button class="btn" type="submit">Subir</button>
                <span id="msgUpload" class="muted"></span>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast"></div>
<section id="calendario" class="section" style="display:none">
  <h2>Mi calendario</h2>
  <div class="card" style="margin-bottom:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <button class="btn" id="calPrev">◀</button>
    <div id="calTitle" style="font-weight:700"></div>
    <button class="btn" id="calNext">▶</button>
    <button class="btn" id="calToday" style="margin-left:auto">Hoy</button>
  </div>
  <div class="card">
    <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px"></div>
  </div>
</section>

  <script>
    // ===== Helpers básicos
    const $  = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const toast = (m, t=2200)=>{ const x=$('#toast'); x.textContent=m; x.style.display='block'; setTimeout(()=>x.style.display='none', t); };
    const fmtDate = s => { if(!s) return '—'; const d=new Date(s); return isNaN(d)? String(s) : d.toISOString().replace('T',' ').slice(0,16); };
    const splitInterests = s => Array.isArray(s)? s : String(s||'').split(',').map(x=>x.trim()).filter(Boolean);
    const fillSelect = (el, rows, {value='id', label='name', withEmpty=true, emptyText='— selecciona —'}={})=>{
      if(!el) return; el.innerHTML=''; if(withEmpty){ const o=document.createElement('option'); o.value=''; o.textContent=emptyText; el.appendChild(o); }
      rows.forEach(r=>{ const o=document.createElement('option'); o.value=r[value]??''; o.textContent=r[label]??r[value]??''; el.appendChild(o); });
    };

    // ===== Auth + API
    const getToken   = ()=> localStorage.getItem('token') || '';
    const setToken   = (t)=> localStorage.setItem('token', t||'');
    const clearToken = ()=> localStorage.removeItem('token');
    const authHeaders = ()=> { const t=getToken(); return t? { Authorization:'Bearer '+t } : {}; };
    const apiGet  = (op, qs={}) => fetch('/.netlify/functions/api?' + new URLSearchParams({op, ...qs}), { headers: authHeaders() }).then(r=>r.json());
    const apiPost = (op, body)   => fetch('/.netlify/functions/api?' + new URLSearchParams({op}), { method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(body||{}) }).then(r=>r.json());
    const loginPost = (email, password)=> fetch('/.netlify/functions/auth-login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password}) }).then(r=>r.json());

    // ===== Estado
    const state = { me:null, destinations:[], services:[], myRequests:[], editCurrent:null };

    // ===== UI: mostrar/ocultar secciones sin redirigir páginas
    function showOnly(id){
      $$('.section').forEach(s => s.style.display = (s.id===id ? 'block' : 'none'));
      // Sidebar visible solo si NO estamos en login
      $('#leftNav').style.display = (id==='login') ? 'none' : 'grid';
      $('#btnLogout').style.display = (id==='login') ? 'none' : 'inline-flex';
      // Nav activo
      $$('#leftNav a').forEach(a=> a.classList.toggle('active', a.getAttribute('href')==='#'+id));
    }

    // ===== Prefetch
    async function prefetchRefs(){
      const [dests, servs] = await Promise.allSettled([apiGet('public-destinations'), apiGet('public-services')]);
      state.destinations = dests.value?.ok ? (dests.value.items||[]) : [];
      state.services     = servs.value?.ok ? (servs.value.items||[]) : [];
      // rellenar "Nueva"
      fillSelect($('#selDestinationNew'), state.destinations);
      refreshServiceSelectFor('#selServiceNew', $('#selKindNew')?.value || '');
    }
    function refreshServiceSelectFor(selectCss, kind=''){
      const el = $(selectCss); if(!el) return;
      const items = state.services.filter(s => !kind || s.service_kind===kind);
      const rows = items.map(s => ({ id: s.id, name: `${s.name}${s.destination? ' · '+s.destination:''}` }));
      fillSelect(el, rows, { withEmpty:true, emptyText:'— (opcional) —' });
    }

    // ===== HOME
    async function loadHome(){
      $('#homeErr').style.display='none';
      const r = await apiGet('client-requests-list');
      if(!r.ok){
        $('#homeErr').textContent = r.error || 'Error';
        $('#homeErr').style.display='block';
        $('#tblMyRecent').innerHTML = '<tr><td colspan="6">Error</td></tr>';
        return;
      }
      const items = r.items||[];
      state.myRequests = items;
      $('#kpiMine').textContent = String(items.length);
      const counts = items.reduce((a,x)=> (a[x.current_status||'new']=(a[x.current_status||'new']||0)+1,a),{});
      const chips = $('#chipsMine'); chips.innerHTML='';
      Object.entries(counts).forEach(([k,v])=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=`${k}: ${v}`; chips.appendChild(s); });
      const tb = $('#tblMyRecent'); tb.innerHTML='';
      items.slice(0,10).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.id}</td>
          <td>${it.servicio || it.servicio_kind || it.service_kind || '—'}</td>
          <td>${it.destino || '—'}</td>
          <td>${it.current_status || 'new'}</td>
          <td>${fmtDate(it.created_at || it.start_date)}</td>
          <td><a class="btn" href="#solicitudes/edit?id=${encodeURIComponent(it.id)}">Editar</a></td>
        `;
        tb.appendChild(tr);
      });
    }

    // ===== NUEVA
    function bindNueva(){
      $('#selKindNew')?.addEventListener('change', e=>{
        refreshServiceSelectFor('#selServiceNew', e.target.value);
      });
      $('#formNewReq')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        $('#newErr').style.display='none';
        const f = e.target;
        const data = Object.fromEntries(new FormData(f).entries());
        const payload = {
          service_kind: data.service_kind || '',
          destination_id: data.destination_id || null,
          catalog_id: data.catalog_id || null,
          start_date: data.start_date || null,
          end_date: data.end_date || null,
          guests: data.guests ? +data.guests : null,
          budget_usd: data.budget_usd ? +data.budget_usd : null,
          dietary_notes: data.dietary_notes || null,
          interests: splitInterests(data.interests),
          notes: data.notes || null,
        };
        const r = await apiPost('client-requests-upsert', payload);
        if(!r.ok){
          $('#newErr').textContent = r.error || 'Error al crear';
          $('#newErr').style.display='block';
          toast(r.error||'Error');
          return;
        }
        toast('Solicitud creada');
        f.reset();
        await Promise.all([loadHome(), loadMisSolicitudes()]);
        location.hash='#mis-solicitudes'; // sigue siendo MISMA PÁGINA, solo cambia sección
      });
    }

    // ===== LISTAR
    async function loadMisSolicitudes(){
      $('#listErr').style.display='none';
      const st = $('#fltStatusMyReq')?.value || '';
      const r = await apiGet('client-requests-list', st?{status:st}:{});
      const tb = $('#tblMyReq');
      if(!r.ok){
        $('#listErr').textContent = r.error || 'Error';
        $('#listErr').style.display='block';
        tb.innerHTML = `<tr><td colspan="6">${r.error||'Error'}</td></tr>`;
        return;
      }
      const items = r.items || [];
      state.myRequests = items;
      if(items.length===0){ tb.innerHTML = '<tr><td colspan="6">Sin resultados</td></tr>'; return; }
      tb.innerHTML = '';
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.id}</td>
          <td>${it.servicio || it.servicio_kind || it.service_kind || '—'}</td>
          <td>${it.destino || '—'}</td>
          <td>${fmtDate(it.created_at || it.start_date)}</td>
          <td>${it.current_status || 'new'}</td>
          <td><a class="btn" href="#solicitudes/edit?id=${encodeURIComponent(it.id)}">Editar</a></td>
        `;
        tb.appendChild(tr);
      });
    }
    function bindMisSolicitudes(){
      $('#btnLoadMyReq')?.addEventListener('click', loadMisSolicitudes);
    }

    // ===== EDIT
    const previewEdit = (data, box)=>{
      if(!box) return;
      const lines = [];
      const kind = data.service_kind || '—';
      lines.push(`Servicio: ${kind}`);
      lines.push(`Destino: ${data.destination_id || '—'}`);
      lines.push(`Catálogo: ${data.catalog_id || '—'}`);
      lines.push(`Desde: ${data.start_date || '—'}  Hasta: ${data.end_date || '—'}`);
      lines.push(`Huéspedes: ${data.guests ?? '—'}  Presupuesto: ${data.budget_usd ?? '—'}`);
      lines.push(`Alimentación: ${data.dietary_notes || '—'}`);
      lines.push(`Intereses: ${splitInterests(data.interests).join(', ') || '—'}`);
      lines.push(`Notas: ${data.notes || '—'}`);
      box.textContent = lines.join('\n');
    };
    function fillEditSelects(){
      fillSelect($('#selDestinationEdit'), state.destinations, { withEmpty:true, emptyText:'— sin destino —' });
      const kind = $('#formReqEdit [name="service_kind"]')?.value || '';
      const items = state.services.filter(s => !kind || s.service_kind===kind);
      const rows = items.map(s => ({ id:s.id, name:`${s.name}${s.destination? ' · '+s.destination:''}` }));
      fillSelect($('#selServiceEdit'), rows, { withEmpty:true, emptyText:'— (opcional) —' });
    }
    function bindEditForm(){
      const form = $('#formReqEdit'); if(!form) return;
      form.addEventListener('change', e=>{
        if (e.target.name==='service_kind') fillEditSelects();
      });
      form.addEventListener('input', ()=>{
        const data = Object.fromEntries(new FormData(form).entries());
        data.interests = splitInterests(data.interests);
        previewEdit(data, $('#reqPreview'));
      });
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        $('#editErr').style.display='none';
        const data = Object.fromEntries(new FormData(e.target).entries());
        const payload = {
          id: data.id,
          service_kind: data.service_kind,
          destination_id: data.destination_id || null,
          catalog_id: data.catalog_id || null,
          start_date: data.start_date || null,
          end_date: data.end_date || null,
          guests: data.guests ? +data.guests : null,
          budget_usd: data.budget_usd ? +data.budget_usd : null,
          dietary_notes: data.dietary_notes || null,
          interests: splitInterests(data.interests),
          notes: data.notes || null,
        };
        const r = await apiPost('client-requests-upsert', payload);
        if(!r.ok){
          $('#editErr').textContent = r.error || 'Error guardando';
          $('#editErr').style.display='block';
          toast(r.error||'Error');
          return;
        }
        toast('Guardado');
        await loadMisSolicitudes();
      });
      $('#btnCancelReq')?.addEventListener('click', async ()=>{
        $('#editErr').style.display='none';
        const id = form.elements.id?.value;
        if(!id) return toast('Sin id');
        const r = await apiPost('client-requests-status', { id, to_status:'discarded' });
        if(!r.ok){
          $('#editErr').textContent = r.error || 'Error al cancelar';
          $('#editErr').style.display='block';
          toast(r.error||'Error');
          return;
        }
        toast('Solicitud cancelada');
        await loadMisSolicitudes();
        location.hash = '#mis-solicitudes';
      });
    }
    async function loadAdjuntosList(requestId){
      const ul = $('#attachmentsList'); if(!ul) return;
      const r = await apiGet('client-attachments-list', { request_id: requestId });
      if(!r.ok){ ul.innerHTML = `<li class="muted">${r.error||'Error'}</li>`; return; }
      if((r.items||[]).length===0){ ul.innerHTML = `<li class="muted">Sin adjuntos</li>`; return; }
      ul.innerHTML = '';
      for(const a of r.items){
        const li = document.createElement('li');
        const label = a.file_name || a.storage_url || a.id;
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <div><b>${label}</b></div>
              <div class="muted">${a.mime_type} · ${(a.size_bytes??0)} bytes · ${fmtDate(a.created_at)}</div>
            </div>
            ${a.storage_url? `<a class="btn" href="${a.storage_url}" target="_blank" rel="noopener">Ver</a>`:''}
          </div>
        `;
        ul.appendChild(li);
      }
    }
    async function enterEditById(id){
      let req = state.myRequests.find(r=>r.id===id);
      if(!req){
        const d = await apiGet('client-requests-list');
        if(d.ok) state.myRequests = d.items||[];
        req = state.myRequests.find(r=>r.id===id);
      }
      if(!req){ toast('No se encontró la solicitud'); location.hash='#mis-solicitudes'; return; }

      showOnly('solicitud-edit');
      fillEditSelects();

      const form = $('#formReqEdit'); form.reset();
      form.elements.id.value = req.id;
      form.elements.service_kind.value = (req.service_kind || req.servicio_kind || 'tour');
      fillEditSelects();
      if (req.destination_id) form.elements.destination_id.value = req.destination_id;
      if (req.catalog_id)     form.elements.catalog_id.value     = req.catalog_id;
      if (req.start_date)     form.elements.start_date.value     = req.start_date;
      if (req.end_date)       form.elements.end_date.value       = req.end_date;
      if (req.guests!=null)   form.elements.guests.value         = req.guests;
      if (req.budget_usd!=null) form.elements.budget_usd.value   = req.budget_usd;
      if (req.dietary_notes)  form.elements.dietary_notes.value  = req.dietary_notes;
      const ints = Array.isArray(req.interests) ? req.interests : splitInterests(req.interests);
      form.elements.interests.value = ints.join(', ');
      if (req.notes)          form.elements.notes.value          = req.notes;

      previewEdit({
        service_kind: form.elements.service_kind.value,
        destination_id: form.elements.destination_id.value || null,
        catalog_id: form.elements.catalog_id.value || null,
        start_date: form.elements.start_date.value || null,
        end_date: form.elements.end_date.value || null,
        guests: form.elements.guests.value ? +form.elements.guests.value : null,
        budget_usd: form.elements.budget_usd.value ? +form.elements.budget_usd.value : null,
        dietary_notes: form.elements.dietary_notes.value || null,
        interests: splitInterests(form.elements.interests.value),
        notes: form.elements.notes.value || null,
      }, $('#reqPreview'));

      $('#uploadRequestId') && ($('#uploadRequestId').value = req.id);
      await loadAdjuntosList(req.id);
      bindEditForm();
      bindUpload();
    }
    function bindUpload(){
      const f = $('#formUpload'); if(!f) return;
      f.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const rid = $('#uploadRequestId')?.value || f.elements.request_id?.value || '';
        const file = f.elements.file?.files?.[0];
        if(!rid) return toast('request_id requerido');
        if(!file) return toast('Selecciona un archivo');
        const fd = new FormData(); fd.append('request_id', rid); fd.append('file', file);
        const r = await fetch('/.netlify/functions/upload', { method:'POST', headers: authHeaders(), body: fd }).then(x=>x.json());
        if(!r.ok){ $('#msgUpload').textContent = r.error||'Error al subir'; toast(r.error||'Error'); return; }
        $('#msgUpload').textContent = 'Subido';
        await loadAdjuntosList(rid);
        f.reset();
      });
    }

    // ===== Router de secciones (mismo HTML)
    async function router(){
      const hash = location.hash || '#home';
      const needAuth = hash !== '#login';
      const token = getToken();

      if (needAuth && !token) { showOnly('login'); return; }
      if (!needAuth && token) { // estás logueado y entraste a #login a propósito
        $('#leftNav').style.display = 'grid';
      }

      if (hash.startsWith('#solicitudes/edit')){
        const id = new URLSearchParams(hash.split('?')[1]||'').get('id');
        await prefetchRefs();
        await enterEditById(id);
        return;
      }
      if (hash === '#nueva'){
        showOnly('nueva');
        await prefetchRefs(); bindNueva(); return;
      }
      if (hash === '#mis-solicitudes'){
        showOnly('mis-solicitudes');
        await loadMisSolicitudes(); bindMisSolicitudes(); return;
      }
      showOnly('home');
      await loadHome();
      $('#btnRefreshClient')?.addEventListener('click', loadHome);
    }

    // ===== Binds globales
    $('#formLogin')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      $('#loginErr').style.display='none';
      const f = e.target;
      const { email, password } = Object.fromEntries(new FormData(f).entries());
      const r = await loginPost(email, password);
      if(!r.ok){
        $('#loginErr').textContent = r.error || 'Credenciales inválidas';
        $('#loginErr').style.display='block';
        return;
      }
      setToken(r.token);
      state.me = r.user || null;
      $('#who').textContent = r.user ? `Cliente: ${r.user.full_name || r.user.email}` : '';
      toast('Bienvenido');
      location.hash = '#home'; // MISMA PÁGINA, cambiamos sección
    });

    $('#btnLogout')?.addEventListener('click', ()=>{
      clearToken();
      state.me = null; $('#who').textContent = '';
      location.hash = '#login'; // MISMA PÁGINA
    });

    // Enlaces del nav: aseguro que no naveguen fuera
    $$('#leftNav a').forEach(a=>{
      a.addEventListener('click', (ev)=>{
        const href = a.getAttribute('href') || '#home';
        if (href.startsWith('#')) { ev.preventDefault(); location.hash = href; }
      });
    });

    // Init
    (async ()=>{
      const t = getToken();
      if (t) { $('#leftNav').style.display='grid'; $('#btnLogout').style.display='inline-flex'; }
      window.addEventListener('hashchange', router);
      if(!location.hash) location.hash = t ? '#home' : '#login';
      await prefetchRefs();
      await router();
    })();
  </script>
</body>
</html>
